# Charter Backend 项目架构开发规范

## 1. 项目概述

Charter Backend 是一个基于 Spring Boot 3.x 的个人网站项目，采用领域驱动设计（DDD）和分层架构模式，提供中控后台、博客、网盘等核心功能。

## 2. 技术架构

### 2.1 整体架构设计

项目采用**多模块分层架构**，遵循**领域驱动设计（DDD）**思想，实现了清晰的职责分离和依赖解耦。

```
charter-backend-parent/
├── charter-app/                    # 应用启动模块
├── charter-dependencies/            # 依赖版本管理
├── charter-common/                  # 基础设施层
│   ├── charter-common-core/         # 核心工具
│   ├── charter-common-web/          # Web配置
│   ├── charter-common-security/     # 安全认证
│   ├── charter-common-mybatis/      # 数据库配置
│   ├── charter-common-redis/        # 缓存配置
│   ├── charter-common-rabbitmq/     # 消息队列
│   ├── charter-common-file/         # 文件服务
│   ├── charter-common-log/          # 日志管理
│   └── charter-common-job/          # 定时任务
├── charter-domain/                  # 领域层
│   └── charter-domain-admin/        # 管理域
│       ├── charter-domain-admin-api/    # 领域接口
│       └── charter-domain-admin-core/   # 领域实现
└── charter-server/                  # 应用服务层
    └── charter-server-admin/        # 管理服务
```

### 2.2 分层架构说明

#### 2.2.1 应用启动层（charter-app）
- **职责**：项目启动入口，依赖聚合
- **特点**：
  - 包含 Spring Boot 主启动类
  - 聚合所有业务模块依赖
  - 负责最终的 JAR 包构建

#### 2.2.2 基础设施层（charter-common）
- **职责**：提供技术支持，不包含业务逻辑
- **原则**：
  - 不依赖任何业务模块或领域模块
  - 只提供技术组件和工具类
  - 可被其他层复用

#### 2.2.3 领域层（charter-domain）
- **职责**：核心业务逻辑和领域模型
- **设计原则**：
  - **API模块**：只包含接口定义和领域模型，不依赖任何其他模块
  - **Core模块**：实现领域接口，封装业务逻辑
  - 遵循 Repository 模式进行数据访问

#### 2.2.4 应用服务层（charter-server）
- **职责**：对外提供 REST API，协调领域服务
- **特点**：
  - 包含 Controller、Service、DTO、VO 等
  - 依赖领域层接口，不直接依赖实现
  - 负责数据转换和业务流程编排

## 3. 设计思想与原则

### 3.1 核心设计思想

#### 3.1.1 领域驱动设计（DDD）
- **聚合根**：以业务实体为中心组织代码
- **仓储模式**：通过 Repository 接口抽象数据访问
- **领域服务**：封装复杂的业务逻辑

#### 3.1.2 依赖倒置原则
- 高层模块不依赖低层模块，都依赖抽象
- Service 层依赖 Repository 接口，而非具体实现
- 通过接口实现模块间的解耦

#### 3.1.3 单一职责原则
- 每个模块职责明确，边界清晰
- 基础设施层只提供技术支持
- 领域层专注业务逻辑
- 应用层负责协调和对外服务

### 3.2 架构优势

1. **高内聚低耦合**：模块间依赖关系清晰，易于维护
2. **可测试性强**：通过接口抽象，便于单元测试
3. **可扩展性好**：新增业务域只需添加对应模块
4. **技术栈解耦**：基础设施层可独立升级技术组件

## 4. 主要依赖及版本

### 4.1 核心框架

| 组件 | 版本 | 说明 |
|------|------|------|
| Java | 17 | JDK版本 |
| Spring Boot | 3.3.6 | 核心框架 |
| Spring Security | 3.3.6 | 安全框架 |
| Spring Data Redis | 3.3.6 | Redis集成 |
| Spring Boot Starter AOP | 3.3.6 | 面向切面编程 |

### 4.2 数据库相关

| 组件 | 版本 | 说明 |
|------|------|------|
| MyBatis Plus | 3.5.8 | ORM框架 |
| MySQL Connector | 8.0.33 | MySQL驱动 |

### 4.3 工具库

| 组件 | 版本 | 说明 |
|------|------|------|
| Lombok | 1.18.30 | 代码生成工具 |
| Hutool | 5.8.25 | Java工具库 |
| FastJSON2 | 2.0.43 | JSON处理 |
| MapStruct | 1.5.5.Final | 对象映射 |
| Jackson | 2.18.4 | JSON序列化 |

### 4.4 文档和API

| 组件 | 版本 | 说明 |
|------|------|------|
| Knife4j | 4.4.0 | API文档生成 |

### 4.5 第三方服务

| 组件 | 版本 | 说明 |
|------|------|------|
| Aliyun OSS SDK | 3.18.3 | 阿里云对象存储 |
| QQWry Java | 0.8.0 | IP地址库 |
| JJWT | 0.12.3 | JWT处理 |

### 4.6 消息队列

| 组件 | 版本 | 说明 |
|------|------|------|
| Spring Boot Starter AMQP | 3.3.6 | RabbitMQ集成 |

### 4.7 任务调度

| 组件 | 版本 | 说明 |
|------|------|------|
| Spring Boot Starter Quartz | 3.3.6 | 定时任务 |

## 5. 开发规范

### 5.1 模块依赖规范

#### 5.1.1 依赖方向
```
charter-app
    ↓
charter-server-*
    ↓
charter-domain-*-api
    ↑
charter-domain-*-core
    ↓
charter-common-*
```

#### 5.1.2 依赖原则
- **charter-app**：只依赖 server 模块和 domain-core 模块
- **charter-server-***：只依赖对应的 domain-api 模块和 common 模块
- **charter-domain-*-api**：不依赖任何其他业务模块
- **charter-domain-*-core**：依赖对应的 api 模块和 common 模块
- **charter-common-***：不依赖任何业务模块

### 5.2 代码结构规范

#### 5.2.1 包命名规范
```
ink.charter.website
├── common.*                 # 基础设施
├── domain.*.api.*          # 领域接口
├── domain.*.core.*         # 领域实现
└── server.*.*              # 应用服务
```

#### 5.2.2 类命名规范
- **Controller**：以 `Controller` 结尾
- **Service**：接口以 `Service` 结尾，实现类以 `ServiceImpl` 结尾
- **Repository**：接口以 `Repository` 结尾，实现类以 `RepositoryImpl` 结尾
- **Entity**：以 `Entity` 结尾
- **DTO**：以 `DTO` 结尾
- **VO**：以 `VO` 结尾
- **Converter**：以 `Converter` 结尾

### 5.3 分层职责规范

#### 5.3.1 Controller层
- **职责**：接收HTTP请求，参数校验，调用Service，返回响应
- **规范**：
  - 使用 `@RestController` 注解
  - 使用 `@RequestMapping` 定义路径
  - 使用 Swagger 注解生成API文档
  - 不包含业务逻辑，只做参数转换和结果封装

```java
@RestController
@RequestMapping("/api/admin/users")
@Tag(name = "用户管理", description = "用户相关接口")
public class UserController {
    
    private final UserService userService;
    
    @PostMapping
    @Operation(summary = "创建用户")
    public Result<UserVO> createUser(@Valid @RequestBody CreateUserDTO dto) {
        // 参数转换 -> 调用服务 -> 结果转换
    }
}
```

#### 5.3.2 Service层
- **职责**：业务流程编排，调用Repository，事务管理
- **规范**：
  - 接口定义在 server 模块
  - 实现类使用 `@Service` 注解
  - 使用 `@Transactional` 管理事务
  - 依赖 Repository 接口，不直接操作数据库

```java
@Service
@RequiredArgsConstructor
public class UserServiceImpl implements UserService {
    
    private final SysUserRepository sysUserRepository;
    
    @Override
    @Transactional
    public void createUser(CreateUserDTO dto) {
        // 业务逻辑处理
        // 调用Repository
    }
}
```

#### 5.3.3 Repository层
- **职责**：数据访问抽象，封装数据库操作
- **规范**：
  - 接口定义在 domain-api 模块
  - 实现类在 domain-core 模块，使用 `@Repository` 注解
  - 封装复杂查询逻辑
  - 不包含业务逻辑

```java
// 接口定义（domain-api）
public interface SysUserRepository {
    void save(SysUserEntity user);
    SysUserEntity findById(Long id);
    List<SysUserEntity> findByCondition(UserQueryCondition condition);
}

// 实现类（domain-core）
@Repository
@RequiredArgsConstructor
public class SysUserRepositoryImpl implements SysUserRepository {
    
    private final SysUserMapper sysUserMapper;
    
    @Override
    public void save(SysUserEntity user) {
        // 数据库操作
    }
}
```

### 5.4 数据传输对象规范

#### 5.4.1 DTO（Data Transfer Object）
- **用途**：Controller 接收前端数据
- **位置**：server 模块的 dto 包
- **规范**：
  - 使用 Bean Validation 注解进行参数校验
  - 字段命名使用驼峰命名法
  - 提供必要的 getter/setter 方法

```java
@Data
public class CreateUserDTO {
    @NotBlank(message = "用户名不能为空")
    private String username;
    
    @Email(message = "邮箱格式不正确")
    private String email;
}
```

#### 5.4.2 VO（View Object）
- **用途**：Controller 返回给前端的数据
- **位置**：server 模块的 vo 包
- **规范**：
  - 只包含前端需要的字段
  - 敏感信息不暴露（如密码）

```java
@Data
public class UserVO {
    private Long id;
    private String username;
    private String email;
    private LocalDateTime createTime;
}
```

#### 5.4.3 Entity
- **用途**：数据库实体映射
- **位置**：charter-domain-*-api 模块
- **规范**：
  - 使用 MyBatis Plus 注解
  - 字段与数据库表字段对应

```java
@Data
@TableName("sys_user")
public class SysUserEntity {
    @TableId(type = IdType.ASSIGN_ID)
    private Long id;
    
    private String username;
    private String password;
    private String email;
    
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;
}
```

### 5.5 对象转换规范

使用 MapStruct 进行对象转换：

```java
@Mapper(componentModel = "spring")
public interface UserConverter {
    
    SysUserEntity toEntity(CreateUserDTO dto);
    
    UserVO toVO(SysUserEntity entity);
    
    List<UserVO> toVOList(List<SysUserEntity> entities);
}
```

### 5.6 异常处理规范

#### 5.6.1 全局异常处理
- 使用 `@ControllerAdvice` 统一处理异常
- 定义业务异常类型
- 返回统一的错误响应格式

#### 5.6.2 业务异常
```java
public class BusinessException extends RuntimeException {
    private final String code;
    private final String message;
}
```

### 5.7 日志规范

#### 5.7.1 日志级别
- **ERROR**：系统错误，需要立即处理
- **WARN**：警告信息，需要关注
- **INFO**：重要的业务流程信息
- **DEBUG**：调试信息，生产环境关闭

#### 5.7.2 日志格式
```java
@Slf4j
public class UserServiceImpl {
    
    public void createUser(CreateUserDTO dto) {
        log.info("开始创建用户，用户名：{}", dto.getUsername());
        try {
            // 业务逻辑
            log.info("用户创建成功，ID：{}", user.getId());
        } catch (Exception e) {
            log.error("用户创建失败，用户名：{}", dto.getUsername(), e);
            throw e;
        }
    }
}
```

### 5.8 安全规范

#### 5.8.1 认证授权
- 使用 JWT 进行身份认证
- 使用 Spring Security 进行权限控制
- 敏感接口添加权限注解

```java
@PreAuthorize("hasRole('ADMIN')")
@PostMapping("/users")
public Result<UserVO> createUser(@RequestBody CreateUserDTO dto) {
    // 只有管理员可以创建用户
}
```

#### 5.8.2 数据安全
- 密码使用 BCrypt 加密
- 敏感信息不记录日志
- SQL 注入防护（使用 MyBatis 参数化查询）

### 5.9 测试规范

#### 5.9.1 单元测试
- Service 层必须编写单元测试
- 使用 Mock 隔离依赖
- 测试覆盖率不低于 80%

```java
@ExtendWith(MockitoExtension.class)
class UserServiceImplTest {
    
    @Mock
    private SysUserRepository sysUserRepository;
    
    @InjectMocks
    private UserServiceImpl userService;
    
    @Test
    void shouldCreateUserSuccessfully() {
        // Given
        CreateUserDTO dto = new CreateUserDTO();
        dto.setUsername("test");
        
        // When
        userService.createUser(dto);
        
        // Then
        verify(sysUserRepository).save(any(SysUserEntity.class));
    }
}
```

#### 5.9.2 集成测试
- Controller 层编写集成测试
- 使用 TestContainers 进行数据库测试

### 5.10 性能规范

#### 5.10.1 数据库优化
- 合理使用索引
- 避免 N+1 查询问题
- 大数据量查询使用分页

#### 5.10.2 缓存策略
- 热点数据使用 Redis 缓存
- 设置合理的过期时间
- 注意缓存一致性

## 6. 构建和部署

### 6.1 构建命令
```bash
# 编译项目
mvn clean compile

# 运行测试
mvn test

# 打包项目
mvn clean package

# 安装到本地仓库
mvn clean install
```

### 6.2 环境配置
- **开发环境**：application-dev.yml
- **测试环境**：application-test.yml
- **生产环境**：application-prod.yml

### 6.3 部署要求
- JDK 17+
- MySQL 8.0+
- Redis 6.0+
- RabbitMQ 3.8+

## 7. 开发工具推荐

### 7.1 IDE
- **IntelliJ IDEA**：推荐使用，支持 Spring Boot 开发
- **VS Code**：轻量级选择

### 7.2 插件
- **Lombok Plugin**：支持 Lombok 注解
- **MyBatis Plugin**：MyBatis 支持
- **Spring Boot Plugin**：Spring Boot 支持

### 7.3 代码质量
- **SonarQube**：代码质量检查
- **SpotBugs**：静态代码分析
- **Checkstyle**：代码风格检查

## 8. 版本管理

### 8.1 Git 工作流
- 使用 Git Flow 工作流
- 主分支：main
- 开发分支：develop
- 功能分支：feature/*
- 修复分支：hotfix/*

### 8.2 提交规范
```
type(scope): subject

body

footer
```

类型说明：
- **feat**：新功能
- **fix**：修复bug
- **docs**：文档更新
- **style**：代码格式调整
- **refactor**：重构
- **test**：测试相关
- **chore**：构建过程或辅助工具的变动

## 9. 总结

本项目采用现代化的 Java 技术栈和架构设计，通过合理的模块划分和分层设计，实现了高内聚低耦合的系统架构。开发团队应严格遵循本规范，确保代码质量和项目的可维护性。

随着项目的发展，本规范也会持续更新和完善，请开发人员及时关注变更。